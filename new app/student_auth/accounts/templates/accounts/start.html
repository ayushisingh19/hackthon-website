{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sage Coding Competition</title>
<link rel="stylesheet" href="{% static 'css/style.css' %}">
<style>
  body {margin:0;font-family:'Segoe UI',sans-serif;background:#f9f9fc;display:flex;flex-direction:column;height:100vh;}
  header {background:#282c34;color:#61dafb;padding:15px;font-size:20px;font-weight:bold;}
  main {flex:1;display:grid;grid-template-columns:10% 45% 45%;overflow:hidden;transition:all .3s ease;}
  
  /* Sidebar */
  .problems-list {background:#fff;border-right:2px solid #ddd;padding:10px;overflow:auto;}
  .problems-list h2 {margin-bottom:10px;font-size:14px;color:#222;text-align:center;}
  .problem-card {background:#fff;border:1px solid #ccc;border-radius:8px;padding:8px;margin-bottom:10px;transition:all .3s;font-size:12px;}
  .problem-card:hover {border-color:#7c3aed;box-shadow:0 3px 8px rgba(124,58,237,0.15);}
  .problem-title {font-weight:bold;font-size:13px;margin-bottom:3px;}
  .difficulty {display:inline-block;padding:2px 6px;border-radius:8px;font-size:10px;font-weight:600;}
  .difficulty-easy{background:#e6fef0;color:#16a34a;}
  .difficulty-medium{background:#fff7db;color:#b45309;}
  .difficulty-hard{background:#fde2e2;color:#dc2626;}
  .solve-btn{display:inline-block;margin-top:5px;background:#7c3aed;color:#fff;padding:3px 8px;border-radius:5px;text-decoration:none;font-size:11px;}
  
  /* Problem Details */
  .problem-detail{background:#2c2f48;color:#eee;padding:20px;overflow:auto;font-family:monospace;}
  .problem-detail h2{color:#61dafb;}
  
  /* Editor */
  .editor-section{display:flex;flex-direction:column;background:#1e1e2f;position:relative;}
  .controls{padding:10px;background:#282c34;display:flex;gap:10px;}
  .controls select,.controls button{padding:7px;background:#3a3a4d;color:#eee;border:none;border-radius:3px;cursor:pointer;}
  .editor{flex:1;background:#1e1e2f;color:#d4d4d4;border:none;padding:15px;font-family:monospace;font-size:1rem;resize:none;outline:none;}
  .console{height:150px;background:#222433;padding:10px;overflow:auto;white-space:pre-wrap;font-size:0.9rem;color:#eee;}
  
  /* Fullscreen mode */
  .fullscreen {position:fixed !important;top:0;left:0;width:100% !important;height:100% !important;z-index:1000;display:flex;flex-direction:column;}
</style>
</head>
<body>
<header>üß† Sage Coding Competition</header>
<main id="mainLayout">
  <!-- Left Sidebar -->
  <section class="problems-list">
    <h2>Problems</h2>
    {% for p in problems %}
      <div class="problem-card">
        <div class="problem-title">{{ forloop.counter }}. {{ p.title }}</div>
        <div class="difficulty difficulty-{{ p.difficulty|lower }}">{{ p.difficulty }}</div><br>
        <a href="{% url 'problem_detail' p.id %}" class="solve-btn">Solve</a>
      </div>
    {% empty %}
      <p>No problems available.</p>
    {% endfor %}
  </section>

  <!-- Middle Section -->
  <section class="problem-detail">
    {% if problem %}
      <h2>{{ problem.title }}</h2>
      <p><strong>Difficulty:</strong> {{ problem.difficulty }}</p>
      <h3>Description</h3>
      <p>{{ problem.description|linebreaksbr }}</p>
      <h3>Constraints</h3>
      <p>{{ problem.constraints|linebreaksbr }}</p>

      <h3>Test Cases</h3>
      <div id="test-cases">‚è≥ Loading test cases...</div>

    {% else %}
      <p>üëà Select a problem to view details.</p>
    {% endif %}
  </section>

  <!-- Right Section -->
  <section class="editor-section" id="editorSection">
    <div class="controls">
      <select id="lang">
        <option value="python">Python</option>
        <option value="java">Java</option>
      </select>
      <button id="runBtn">‚ñ∂ Run</button>
      <button id="submitBtn">‚úÖ Submit</button>
      <button id="toggleFullscreen">üî≤ Fullscreen</button>
    </div>
    <textarea class="editor" id="editor" placeholder="Write your code here..."></textarea>
    {% if problem %}
    <div class="console" id="console">Your results will appear here...</div>
    {% endif %}
  </section>
</main>

{% if problem %}
  <script>
    const runCodeUrl = "{% url 'run_code' problem.id %}";
    const testCaseUrl = "{% url 'get_visible_testcases' problem.id %}";

    // fetch visible testcases
    fetch(testCaseUrl)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("test-cases");
        if (!data.visible_testcases || data.visible_testcases.length === 0) {
          container.innerHTML = "<p>No public test cases.</p>";
          return;
        }
        container.innerHTML = "";
        data.visible_testcases.forEach(tc => {
          container.innerHTML += `
            <pre>
<b>Test Case #${tc.test_case_no}</b>
Input:
${tc.stdin}

Expected:
${tc.expected_output}
</pre>`;
        });
      })
      .catch(err => {
        console.error(err);
        document.getElementById("test-cases").innerHTML = "<p>‚ö†Ô∏è Error loading test cases.</p>";
      });
  </script>
{% else %}
  <script>
    const runCodeUrl = null;
  </script>
{% endif %}

<script>
  const runBtn = document.getElementById('runBtn');
  const submitBtn = document.getElementById('submitBtn');
  const codeEditor = document.getElementById('editor');
  const consoleOutput = document.getElementById('console');
  const languageSelect = document.getElementById('lang');
  const editorSection = document.getElementById('editorSection');
  const toggleBtn = document.getElementById('toggleFullscreen');

  async function executeCode(actionType) {
    if (!runCodeUrl) {
      consoleOutput.innerText = '‚ö†Ô∏è Select a problem first.';
      return;
    }

    const code = codeEditor.value.trim();
    const language = languageSelect.value;

    if (!code) {
      consoleOutput.innerText = '‚ö†Ô∏è Please write some code.';
      return;
    }
    consoleOutput.innerText = actionType === "run" ? '‚è≥ Running...' : 'üì§ Submitting...';

    try {
      const response = await fetch(runCodeUrl, {
        method: "POST",
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ code: code, language: language, action: actionType })
      });

      const data = await response.json();

      if (!data.results || data.results.length === 0) {
        consoleOutput.innerText = '‚ö†Ô∏è No test cases available.';
        return;
      }

      let output = '';
      data.results.forEach((res, i) => {
        output += `Test Case #${i+1}:\n`;
        output += `Input:\n${res.input}\n`;
        output += `Expected:\n${res.expected}\n`;
        output += `Your Output:\n${res.output}\n`;
        if (res.error) output += `Error:\n${res.error}\n`;
        output += res.passed ? "‚úÖ Passed\n\n" : "‚ùå Failed\n\n";
      });
      consoleOutput.innerText = output;

    } catch (error) {
      console.error(error);
      consoleOutput.innerText = 'üö® Error processing your code.';
    }
  }

  runBtn.addEventListener('click', () => executeCode("run"));
  submitBtn.addEventListener('click', () => executeCode("submit"));

  // Fullscreen toggle
  toggleBtn.addEventListener('click', () => {
    editorSection.classList.toggle('fullscreen');
    if (editorSection.classList.contains('fullscreen')) {
      toggleBtn.innerText = "‚ùé Exit Fullscreen";
    } else {
      toggleBtn.innerText = "üî≤ Fullscreen";
    }
  });
</script>

</body>
</html>
